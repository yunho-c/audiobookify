import React, { useState, useEffect, useRef } from 'react';
import { 
  Play, Pause, SkipForward, SkipBack, 
  Volume2, VolumeX, List, X, 
  Maximize2, Heart, Share2, Settings, 
  MoreHorizontal, ChevronDown, Clock,
  BookOpen, Headphones
} from 'lucide-react';

// --- Mock Data ---
const BOOKS = [
  {
    id: 1,
    title: "The Quantum Paradox",
    author: "Sarah J. Vance",
    duration: "8h 12m",
    color: "from-purple-500 to-indigo-600",
    accent: "bg-purple-500",
    description: "A journey through time and space where reality bends at the will of a single observer.",
    chapters: [
      { id: 1, title: "Chapter 1: The Incident", duration: "15:20" },
      { id: 2, title: "Chapter 2: Event Horizon", duration: "22:15" },
      { id: 3, title: "Chapter 3: SchrÃ¶dinger's Cat", duration: "18:45" },
      { id: 4, title: "Chapter 4: The Void", duration: "25:10" },
    ]
  },
  {
    id: 2,
    title: "Midnight in Kyoto",
    author: "Hiroshi Tanaka",
    duration: "6h 45m",
    color: "from-red-500 to-orange-600",
    accent: "bg-red-500",
    description: "A neon-noir mystery set in the winding streets of futuristic Kyoto.",
    chapters: [
      { id: 1, title: "Chapter 1: Red Lanterns", duration: "12:30" },
      { id: 2, title: "Chapter 2: The Tea House", duration: "19:20" },
      { id: 3, title: "Chapter 3: Silent Blade", duration: "21:05" },
    ]
  },
  {
    id: 3,
    title: "Echoes of the Deep",
    author: "Marina Waters",
    duration: "10h 05m",
    color: "from-cyan-500 to-blue-700",
    accent: "bg-cyan-500",
    description: "Submarine warfare meets cosmic horror in this gripping thriller.",
    chapters: [
      { id: 1, title: "Chapter 1: Dive", duration: "30:00" },
      { id: 2, title: "Chapter 2: Pressure", duration: "28:15" },
      { id: 3, title: "Chapter 3: The Signal", duration: "32:40" },
    ]
  },
  {
    id: 4,
    title: "Silicon Dreams",
    author: "Alex Chen",
    duration: "9h 20m",
    color: "from-emerald-400 to-teal-600",
    accent: "bg-emerald-500",
    description: "The rise and fall of a tech empire built on a lie.",
    chapters: [
      { id: 1, title: "Chapter 1: IPO", duration: "14:10" },
      { id: 2, title: "Chapter 2: The Bug", duration: "16:55" },
    ]
  }
];

// --- Components ---

// 3D Tilt Card Component
const BookCover3D = ({ color, title, author, isLarge = false, onClick }) => {
  const [rotate, setRotate] = useState({ x: 0, y: 0 });
  const [shine, setShine] = useState({ x: 0, y: 0, opacity: 0 });

  const handleMouseMove = (e) => {
    const card = e.currentTarget;
    const rect = card.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    const centerX = rect.width / 2;
    const centerY = rect.height / 2;
    
    const rotateX = ((y - centerY) / centerY) * -15; // Max 15deg rotation
    const rotateY = ((x - centerX) / centerX) * 15;

    setRotate({ x: rotateX, y: rotateY });
    setShine({ x, y, opacity: 1 });
  };

  const handleMouseLeave = () => {
    setRotate({ x: 0, y: 0 });
    setShine({ ...shine, opacity: 0 });
  };

  return (
    <div 
      className={`relative cursor-pointer transition-all duration-200 ease-out perspective-1000 group ${isLarge ? 'w-64 h-96 md:w-80 md:h-[30rem]' : 'w-40 h-60'}`}
      onMouseMove={handleMouseMove}
      onMouseLeave={handleMouseLeave}
      onClick={onClick}
      style={{ perspective: '1000px' }}
    >
      <div 
        className={`w-full h-full rounded-xl shadow-2xl transition-transform duration-100 ease-linear transform-style-3d relative overflow-hidden bg-gradient-to-br ${color}`}
        style={{ 
          transform: `rotateX(${rotate.x}deg) rotateY(${rotate.y}deg) scale3d(1.02, 1.02, 1.02)`,
          boxShadow: `${rotate.y * -1}px ${rotate.x + 10}px 30px rgba(0,0,0,0.4)`
        }}
      >
        {/* Book Spine Effect */}
        <div className="absolute left-0 top-0 bottom-0 w-3 bg-white opacity-10 z-10"></div>
        <div className="absolute left-1 top-0 bottom-0 w-1 bg-black opacity-10 z-10"></div>
        
        {/* Content */}
        <div className="absolute inset-0 p-6 flex flex-col justify-between z-20">
          <div className="flex justify-end">
            <Headphones className="text-white opacity-80" size={isLarge ? 32 : 20} />
          </div>
          <div>
            <h3 className={`font-bold text-white leading-tight ${isLarge ? 'text-3xl mb-2' : 'text-lg mb-1'}`}>
              {title}
            </h3>
            <p className={`text-white font-medium opacity-90 ${isLarge ? 'text-lg' : 'text-xs'}`}>
              {author}
            </p>
          </div>
        </div>

        {/* Dynamic Shine/Glare */}
        <div 
          className="absolute inset-0 pointer-events-none z-30 mix-blend-overlay"
          style={{
            background: `radial-gradient(circle at ${shine.x}px ${shine.y}px, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 60%)`,
            opacity: shine.opacity,
            transition: 'opacity 0.2s'
          }}
        />
        
        {/* Texture Overlay */}
        <div className="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/leather.png')] mix-blend-multiply pointer-events-none"></div>
      </div>
    </div>
  );
};

// Audio Visualizer Animation
const Visualizer = ({ isPlaying }) => {
  return (
    <div className="flex items-center justify-center space-x-1 h-8">
      {[...Array(12)].map((_, i) => (
        <div
          key={i}
          className={`w-1 rounded-full bg-white transition-all duration-300 ${isPlaying ? 'animate-music-bar' : 'h-1 opacity-30'}`}
          style={{ 
            height: isPlaying ? `${Math.random() * 24 + 4}px` : '4px',
            animationDelay: `${i * 0.1}s`,
            animationDuration: '0.8s'
          }}
        />
      ))}
    </div>
  );
};

const formatTime = (seconds) => {
  const m = Math.floor(seconds / 60);
  const s = Math.floor(seconds % 60);
  return `${m}:${s < 10 ? '0' : ''}${s}`;
};

export default function AudiobookApp() {
  const [currentBook, setCurrentBook] = useState(null);
  const [isPlaying, setIsPlaying] = useState(false);
  const [currentTime, setCurrentTime] = useState(0);
  const [duration, setDuration] = useState(300); // Mock duration 5 mins
  const [volume, setVolume] = useState(80);
  const [showChapters, setShowChapters] = useState(false);
  const [view, setView] = useState('library'); // 'library' or 'player'

  // Simulating play progress
  useEffect(() => {
    let interval;
    if (isPlaying) {
      interval = setInterval(() => {
        setCurrentTime((prev) => {
          if (prev >= duration) {
            setIsPlaying(false);
            return 0;
          }
          return prev + 1;
        });
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [isPlaying, duration]);

  const selectBook = (book) => {
    setCurrentBook(book);
    setView('player');
    setIsPlaying(true);
    setCurrentTime(0);
  };

  const togglePlay = () => setIsPlaying(!isPlaying);

  return (
    <div className="min-h-screen bg-gray-900 text-gray-100 font-sans selection:bg-indigo-500 selection:text-white overflow-hidden flex flex-col md:flex-row">
      
      {/* --- Sidebar / Navigation (Desktop) --- */}
      <nav className="hidden md:flex flex-col w-20 bg-gray-900 border-r border-gray-800 items-center py-8 z-50">
        <div className="mb-12 p-3 bg-indigo-600 rounded-xl shadow-lg shadow-indigo-500/30">
          <BookOpen size={24} className="text-white" />
        </div>
        <div className="flex flex-col space-y-8">
          <button 
            onClick={() => setView('library')}
            className={`p-3 rounded-xl transition-all ${view === 'library' ? 'bg-gray-800 text-indigo-400' : 'text-gray-500 hover:text-gray-300'}`}
          >
            <List size={24} />
          </button>
          <button className="p-3 text-gray-500 hover:text-gray-300 rounded-xl transition-all">
            <Heart size={24} />
          </button>
          <button className="p-3 text-gray-500 hover:text-gray-300 rounded-xl transition-all">
            <Settings size={24} />
          </button>
        </div>
      </nav>

      {/* --- Main Content Area --- */}
      <main className="flex-1 relative overflow-hidden flex flex-col h-screen">
        
        {/* Header Mobile */}
        <header className="md:hidden flex justify-between items-center p-6 z-40">
           <div className="p-2 bg-indigo-600 rounded-lg shadow-lg">
            <BookOpen size={20} className="text-white" />
           </div>
           {view === 'player' && (
             <button onClick={() => setView('library')} className="p-2 bg-gray-800 rounded-full">
               <ChevronDown size={20} />
             </button>
           )}
        </header>

        {/* Background Ambient Gradient */}
        <div className="absolute inset-0 z-0 pointer-events-none">
          <div className={`absolute top-[-20%] left-[-10%] w-[50%] h-[50%] rounded-full blur-[120px] opacity-20 transition-colors duration-1000 ${currentBook ? currentBook.accent.replace('bg-', 'bg-') : 'bg-indigo-500'}`}></div>
          <div className="absolute bottom-[-10%] right-[-10%] w-[40%] h-[60%] bg-blue-900 rounded-full blur-[100px] opacity-20"></div>
        </div>

        {/* --- Library View --- */}
        <div 
          className={`absolute inset-0 z-10 p-6 md:p-12 overflow-y-auto transition-all duration-500 transform ${view === 'library' ? 'opacity-100 translate-y-0 scale-100' : 'opacity-0 -translate-y-10 scale-95 pointer-events-none'}`}
        >
          <div className="max-w-7xl mx-auto">
            <h1 className="text-4xl font-bold mb-2">My Library</h1>
            <p className="text-gray-400 mb-12">Continue where you left off</p>

            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8 md:gap-12 pb-24">
              {BOOKS.map((book) => (
                <div key={book.id} className="flex flex-col items-center group">
                  <div className="mb-6 transform transition-transform group-hover:-translate-y-4 duration-300">
                    <BookCover3D 
                      {...book} 
                      onClick={() => selectBook(book)} 
                    />
                  </div>
                  <h3 className="font-bold text-lg text-center truncate w-full">{book.title}</h3>
                  <p className="text-sm text-gray-500">{book.author}</p>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* --- Player View --- */}
        {currentBook && (
          <div 
            className={`absolute inset-0 z-20 flex flex-col md:flex-row items-center justify-center p-6 transition-all duration-700 transform ${view === 'player' ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-full pointer-events-none'}`}
          >
            {/* Back Button Desktop */}
            <button 
              onClick={() => setView('library')}
              className="hidden md:flex absolute top-8 left-8 items-center space-x-2 text-gray-400 hover:text-white transition-colors"
            >
              <ChevronDown className="transform rotate-90" size={20} />
              <span>Back to Library</span>
            </button>

            {/* Left: 3D Cover */}
            <div className="w-full md:w-1/2 flex items-center justify-center perspective-container mb-8 md:mb-0">
               <BookCover3D 
                  color={currentBook.color} 
                  title={currentBook.title} 
                  author={currentBook.author} 
                  isLarge={true} 
                  onClick={togglePlay}
               />
            </div>

            {/* Right: Controls & Info */}
            <div className="w-full md:w-1/2 max-w-md flex flex-col space-y-8 z-30">
              
              <div className="text-center md:text-left space-y-2">
                <h2 className="text-3xl md:text-5xl font-bold leading-tight">{currentBook.title}</h2>
                <p className="text-xl text-gray-400">{currentBook.author}</p>
                <div className="flex items-center justify-center md:justify-start space-x-2 mt-2">
                   <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-white/10 text-white`}>
                     Fiction
                   </span>
                   <span className="text-xs text-gray-500 flex items-center">
                     <Clock size={12} className="mr-1"/> {currentBook.duration}
                   </span>
                </div>
              </div>

              {/* Visualizer */}
              <div className="h-12 flex items-center justify-center md:justify-start">
                 <Visualizer isPlaying={isPlaying} />
              </div>

              {/* Progress Bar */}
              <div className="space-y-2 group">
                <input 
                  type="range" 
                  min="0" 
                  max={duration} 
                  value={currentTime} 
                  onChange={(e) => setCurrentTime(parseInt(e.target.value))}
                  className="w-full h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-indigo-500 hover:h-2 transition-all"
                />
                <div className="flex justify-between text-xs text-gray-500 font-mono">
                  <span>{formatTime(currentTime)}</span>
                  <span>-{formatTime(duration - currentTime)}</span>
                </div>
              </div>

              {/* Main Controls */}
              <div className="flex items-center justify-between px-4">
                 <button className="text-gray-400 hover:text-white transition-colors">
                   <SkipBack size={28} />
                 </button>
                 
                 <button 
                  onClick={togglePlay}
                  className={`w-20 h-20 rounded-full flex items-center justify-center shadow-2xl transition-transform hover:scale-105 active:scale-95 bg-gradient-to-br ${currentBook.color}`}
                 >
                   {isPlaying ? <Pause size={32} fill="white" /> : <Play size={32} fill="white" className="ml-1" />}
                 </button>

                 <button className="text-gray-400 hover:text-white transition-colors">
                   <SkipForward size={28} />
                 </button>
              </div>

              {/* Secondary Controls */}
              <div className="flex items-center justify-between pt-4 border-t border-gray-800">
                <button 
                  onClick={() => setShowChapters(!showChapters)}
                  className="flex items-center space-x-2 text-sm text-gray-400 hover:text-white transition-colors"
                >
                  <List size={18} />
                  <span>Chapters</span>
                </button>
                
                <div className="flex items-center space-x-3 w-32 group">
                  {volume === 0 ? <VolumeX size={18} className="text-gray-400"/> : <Volume2 size={18} className="text-gray-400"/>}
                  <div className="h-1 flex-1 bg-gray-700 rounded-full overflow-hidden">
                    <div 
                      className="h-full bg-gray-400 group-hover:bg-white transition-colors" 
                      style={{ width: `${volume}%` }}
                    />
                  </div>
                </div>

                <button className="text-gray-400 hover:text-white">
                  <Share2 size={18} />
                </button>
              </div>
            </div>

            {/* Floating Chapters Panel */}
            <div 
              className={`absolute bottom-0 left-0 right-0 bg-gray-800/95 backdrop-blur-xl rounded-t-3xl p-6 transition-transform duration-500 z-50 h-[60vh] md:h-auto md:w-96 md:right-8 md:left-auto md:bottom-24 md:rounded-2xl border border-white/5 shadow-2xl ${showChapters ? 'translate-y-0' : 'translate-y-[120%]'}`}
            >
              <div className="flex justify-between items-center mb-6">
                <h3 className="font-bold text-lg">Chapters</h3>
                <button onClick={() => setShowChapters(false)} className="p-1 hover:bg-white/10 rounded-full">
                  <X size={20} />
                </button>
              </div>
              <div className="space-y-1 overflow-y-auto max-h-[40vh]">
                {currentBook.chapters.map((chapter) => (
                  <div 
                    key={chapter.id}
                    className="p-3 rounded-lg hover:bg-white/5 cursor-pointer flex justify-between items-center group transition-colors"
                  >
                    <div className="flex items-center space-x-3">
                      <div className="w-6 text-gray-500 text-sm">{chapter.id}</div>
                      <div className="text-sm font-medium group-hover:text-indigo-400 transition-colors">{chapter.title.split(":")[1] || chapter.title}</div>
                    </div>
                    <span className="text-xs text-gray-600">{chapter.duration}</span>
                  </div>
                ))}
              </div>
            </div>

          </div>
        )}
      </main>

      {/* CSS for custom animations */}
      <style jsx>{`
        .perspective-1000 {
          perspective: 1000px;
        }
        .transform-style-3d {
          transform-style: preserve-3d;
        }
        @keyframes music-bar {
          0%, 100% { transform: scaleY(0.5); }
          50% { transform: scaleY(1.5); }
        }
        .animate-music-bar {
          animation-name: music-bar;
          animation-iteration-count: infinite;
          animation-timing-function: ease-in-out;
        }
      `}</style>
    </div>
  );
}